<html>
  <head>
    <title>Room</title>
    <script type="text/javascript">
      const apiKey = "<%=apiKey %>";
      const sessionId = "<%=sessionId %>";
      const token = "<%=token %>";
      const roomId = "<%=roomId %>";
      const pinCode = "<%=pinCode %>";
      const conferenceNumber = "<%=conferenceNumber %>";
      const localtunelUrl = "<%=localtunelUrl %>";
      let connectionId;
    </script>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
      crossorigin="anonymous"
    ></script>
    <script src="https://static.opentok.com/v2/js/opentok.min.js"></script>
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <div class="col-12">
          <p>
            In this demo, we dial out from the video session to voice api
            automatically - in real life, this should be done automatically when
            a user joins the video session. The dial out from video server to
            voice api will connect the video call composed audio of all people
            in the video call to the voice api.
          </p>
          <p>
            After the dial out has been done, you can start dialing the
            conference number from a phone and should be joined into the video
            call as audio participant.
          </p>
        </div>
      </div>

      <div class="row">
        <div class="col-6">
          <span>
            <b>Dial-In Number: </b>
            <a href="tel:<%=conferenceNumber %>"><%=conferenceNumber %></a>
          </span>
          <p><b>Pin Code: </b><%=pinCode %></p>
        </div>
        <div class="col-6">
          <form
            class="row g-1"
            id="dialoutform"
            method="post"
            onsubmit="handleSubmitForm(event)"
          >
            <label for="dialoutview" class="form-label"
              ><b>Dial a Number</b></label
            >
            <div id="dialoutview" class="col" aria-describedby="dialoutHelp">
              <div class="row">
                <div class="col-9">
                  <input
                    id="dialoutNumber"
                    class="form-control"
                    type="text"
                    value="4915140046124"
                  />
                </div>
                <div class="col-3">
                  <button
                    type="submit"
                    class="btn btn-primary"
                    onclick="handleSubmitButton(event)"
                  >
                    Call
                  </button>
                </div>
              </div>
            </div>
            <div id="dialoutHelp" class="form-text">
              You can also dial out to a phone number.
            </div>
          </form>
        </div>
      </div>

      <div class="row">
        <div class="col-6">
          <div id="publisherview"><div id="publisher"></div></div>
        </div>
        <div class="col-6">
          <div id="subscriberview"><div id="subscribers"></div></div>
        </div>
      </div>

      <div class="row">
        <div class="col-12">
          <div id="SipVideoOutDuration">SIP Video Out Duration (always):</div>
          <div id="SipVideoInDuration">SIP Video In Duration (always):</div>
          <div id="pstnInDuration">PSTN Inbound Duration (only dialin):</div>
          <div id="pstnOutDuration">PSTN Outbound Duration (only dialout):</div>
        </div>
        <div class="col-12">
          <table class="table">
            <thead>
              <tr>
                <th scope="col">Video Session ID</th>
                <th scope="col">Call Type</th>
                <th scope="col">SIP Video Out Leg</th>
                <th scope="col">SIP Video In Leg</th>
                <th scope="col">PSTN Dial In Leg</th>
                <th scope="col">PSTN Dial Out Leg</th>
                <th scope="col">SIP Video In ConvID</th>
                <th scope="col">PSTN Dial In ConvID</th>
                <th scope="col">Transfer ConvID</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><%=sessionId %></td>
                <!-- is set by SSR, because created before page load -->

                <td id="callType"></td>
                <!-- is set by signal on dialin and by client js on dialout -->

                <td id="sipVideoOut"></td>
                <!-- is set by signal, on dialout from server -->

                <td id="sipVideoIn"></td>
                <!-- is set by signal, when server gets incoming sip call from video -->

                <td id="pstnIn"></td>
                <!-- is set by signal, when server gets incoming pstn call with correct dtmf from person -->

                <td id="pstnOut"></td>
                <!-- is set by signal, when server gets incoming sip call from video -->

                <td id="sipVideoInConversationID"></td>
                <!-- is set by signal, when server gets incoming sip call from video -->

                <td id="pstnInConversationID"></td>
                <!-- is set by signal, when server gets incoming pstn call with correct dtmf from person -->

                <td id="transferConversationID"></td>
                <!-- is set by signal, when server gets transfer event of existing incoming pstn -->
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script src="/js/opentok.js"></script>
    <script>
      function handleSubmitForm(e) {
        e.preventDefault();
      }
      async function handleSubmitButton(e) {
        e.preventDefault();
        const dialoutNumber = document.getElementById("dialoutNumber").value;
        console.log(dialoutNumber);
        const response = await fetch("<%=localtunelUrl %>/dialout", {
          method: "POST",
          body: JSON.stringify({ dialoutNumber, sessionId }),
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((res, err) => {
            if (err) {
              console.error("Could not fetch. ", err);
              return undefined;
            } else {
              console.log("fetch result ", res);
              return res.json();
            }
          })
          .catch((e) => {
            console.error("Fetch error: ", e);
            return undefined;
          });
        console.log("response json: ", response);
        if (response.id) {
          document.getElementById("callType").innerHTML = "dial out";
          setSipVideoOutHtml(response);
        }
      }
    </script>
  </body>
</html>
